# 病虫害检测服务器项目结构

## 项目概述
这是一个基于Golang + Gin框架的病虫害检测服务器，采用微服务架构设计，支持音频文件上传、虫害检测分析、设备管理等功能。

## 整体架构图
```
┌─────────────────────────────────────────────────────────────────┐
│                        客户端层                                  │
│  Web前端 / 移动端 / IoT设备 / API客户端                          │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                        Gin网关层                                │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   认证中间件     │  │   日志中间件     │  │   错误处理中间件  │ │
│  │   JWT验证       │  │   请求记录       │  │   Panic恢复     │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                        业务逻辑层                                │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   用户认证模块   │  │   音频检测模块   │  │   设备管理模块   │ │
│  │   - 登录注册     │  │   - 文件上传     │  │   - 设备注册     │ │
│  │   - Token管理    │  │   - 特征提取     │  │   - 状态监控     │ │
│  │   - 权限控制     │  │   - 虫害检测     │  │   - 信息查询     │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                        数据访问层                                │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │     MySQL       │  │      Redis      │  │     Kafka       │ │
│  │   - 用户数据     │  │   - 缓存数据     │  │   - 消息队列     │ │
│  │   - 检测结果     │  │   - 会话管理     │  │   - 任务分发     │ │
│  │   - 设备信息     │  │   - 分布式锁     │  │   - 异步处理     │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## 目录结构详解

### 根目录
```
RPW_Detection/
├── Http/                    # HTTP服务器模块
├── config/                  # 配置文件目录
├── .git/                    # Git版本控制
├── .gitignore              # Git忽略文件
├── Dockerfile              # Docker镜像构建文件
├── docker-compose.yml      # Docker服务编排文件
├── Makefile                # 项目构建和部署脚本
├── start.sh                # 项目启动脚本
├── go.mod                  # Go模块依赖文件
├── go.sum                  # Go模块校验文件
├── env.example             # 环境变量示例文件
├── README.md               # 项目说明文档
└── PROJECT_STRUCTURE.md    # 项目结构说明文档
```

### Http模块详细结构
```
Http/
├── http.go                 # 主服务器文件
│   ├── 服务器配置
│   ├── Gin引擎初始化
│   ├── 路由设置
│   └── 服务器启动
│
├── handlers.go             # 请求处理函数
│   ├── 认证相关处理
│   │   ├── handleLogin()      # 用户登录
│   │   ├── handleRegister()   # 用户注册
│   │   └── handleTokenVerify() # Token验证
│   ├── 检测相关处理
│   │   ├── handleAudioUpload() # 音频上传
│   │   ├── handleGetResult()   # 获取检测结果
│   │   └── handleGetStatus()   # 获取检测状态
│   └── 设备相关处理
│       ├── handleDeviceList()    # 设备列表
│       ├── handleDeviceInfo()    # 设备信息
│       └── handleDeviceRegister() # 设备注册
│
├── middleware.go           # 中间件文件
│   ├── JWT认证中间件
│   ├── 请求日志中间件
│   ├── 错误处理中间件
│   ├── 性能监控中间件
│   ├── CORS中间件
│   ├── 请求ID中间件
│   └── 限流中间件
│
├── config.go               # 配置文件
│   ├── 服务器配置
│   ├── 数据库配置
│   ├── Redis配置
│   ├── JWT配置
│   ├── Kafka配置
│   └── 环境变量加载
│
└── handlers_test.go        # 测试文件
    ├── 接口测试
    ├── 结构体测试
    └── 功能验证
```

## 核心模块说明

### 1. 认证模块 (Authentication)
- **功能**: 用户登录、注册、Token管理
- **技术**: JWT (JSON Web Token)
- **特性**: 
  - 支持Token自动刷新
  - 密码MD5加密
  - 会话状态管理

### 2. 音频检测模块 (Audio Detection)
- **功能**: 音频文件处理、虫害检测
- **技术**: HTTP文件上传、异步处理
- **特性**:
  - 支持多种音频格式 (WAV, MP3, FLAC)
  - 分布式锁保证任务唯一性
  - 检测结果缓存

### 3. 设备管理模块 (Device Management)
- **功能**: 设备注册、状态监控、信息查询
- **技术**: RESTful API
- **特性**:
  - 设备在线状态监控
  - 设备信息管理
  - 位置信息记录

### 4. 数据查询模块 (Data Query)
- **功能**: 检测结果查询、历史数据检索
- **技术**: MySQL + Redis + 布隆过滤器
- **特性**:
  - 多层缓存策略
  - 防缓存穿透
  - 联合索引优化

## 技术架构特点

### 1. 微服务架构
- 模块化设计，职责分离
- 支持独立部署和扩展
- 服务间通过HTTP API通信

### 2. 中间件架构
- 可插拔的中间件设计
- 支持自定义中间件扩展
- 统一的错误处理和日志记录

### 3. 配置管理
- 环境变量配置
- 支持开发/测试/生产环境
- 配置热重载支持

### 4. 容器化部署
- Docker镜像构建
- Docker Compose服务编排
- 支持Kubernetes部署

## 数据流设计

### 音频检测流程
```
1. 客户端上传音频文件
   ↓
2. 服务器接收并验证文件
   ↓
3. 生成检测任务ID
   ↓
4. 发送到Kafka消息队列
   ↓
5. 检测服务处理音频特征
   ↓
6. 机器学习模型分析
   ↓
7. 结果存储到数据库
   ↓
8. 客户端查询检测结果
```

### 用户认证流程
```
1. 客户端发送登录请求
   ↓
2. 服务器验证用户名密码
   ↓
3. 生成JWT Token
   ↓
4. 返回Token给客户端
   ↓
5. 客户端后续请求携带Token
   ↓
6. 中间件验证Token有效性
   ↓
7. 允许/拒绝请求访问
```

## 扩展性设计

### 1. 水平扩展
- 无状态服务设计
- 支持多实例部署
- 负载均衡友好

### 2. 垂直扩展
- 模块化代码结构
- 支持功能模块独立升级
- 插件化中间件系统

### 3. 技术栈扩展
- 支持多种数据库
- 支持多种缓存系统
- 支持多种消息队列

## 监控和运维

### 1. 健康检查
- `/api/v1/health` 健康检查接口
- Docker健康检查配置
- 服务状态监控

### 2. 日志管理
- 结构化日志输出
- 请求追踪ID
- 性能指标记录

### 3. 错误处理
- 统一错误响应格式
- 异常自动恢复
- 错误日志记录

## 安全设计

### 1. 认证授权
- JWT Token认证
- 密码加密存储
- 会话管理

### 2. 数据安全
- HTTPS传输加密
- 敏感信息脱敏
- 访问权限控制

### 3. 接口安全
- 请求参数验证
- 防SQL注入
- 限流保护

## 性能优化

### 1. 缓存策略
- Redis缓存热点数据
- 布隆过滤器防穿透
- 多级缓存设计

### 2. 数据库优化
- 索引优化
- 连接池管理
- 查询语句优化

### 3. 并发处理
- Goroutine并发模型
- 连接池复用
- 异步消息处理

## 部署架构

### 开发环境
```
┌─────────────────┐
│   Go应用        │
│   (本地运行)     │
└─────────────────┘
```

### 测试环境
```
┌─────────────────┐  ┌─────────────────┐
│   Go应用        │  │   MySQL        │
│   (Docker)      │  │   (Docker)     │
└─────────────────┘  └─────────────────┘
```

### 生产环境
```
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│   Nginx         │  │   Go应用集群    │  │   数据库集群     │
│   (负载均衡)     │  │   (多实例)      │  │   (主从复制)     │
└─────────────────┘  └─────────────────┘  └─────────────────┘
        │                       │                       │
        └───────────────────────┼───────────────────────┘
                                │
                    ┌─────────────────┐
                    │   Redis集群     │
                    │   (哨兵模式)     │
                    └─────────────────┘
```

## 开发规范

### 1. 代码规范
- Go官方代码规范
- 统一的错误处理
- 完整的注释文档

### 2. 测试规范
- 单元测试覆盖
- 集成测试
- 性能测试

### 3. 部署规范
- 环境配置管理
- 版本控制
- 回滚策略

## 未来规划

### 短期目标 (1-3个月)
- [ ] 完善数据库模型
- [ ] 集成Redis缓存
- [ ] 实现Kafka消息队列
- [ ] 添加单元测试

### 中期目标 (3-6个月)
- [ ] 集成机器学习模型
- [ ] 实现gRPC服务
- [ ] 添加监控告警
- [ ] 性能优化

### 长期目标 (6-12个月)
- [ ] 微服务拆分
- [ ] 容器编排优化
- [ ] 云原生部署
- [ ] 国际化支持
